---
name: Test Ansible Playbooks

on:
  push:
    branches:
      - main
      - feature/*
  pull_request:
    branches:
      - main
  workflow_dispatch:

jobs:
  lint:
    name: Lint Playbooks
    runs-on: ubuntu-latest
    steps:
      - name: Check out code
        uses: actions/checkout@v6

      - name: Install uv
        uses: astral-sh/setup-uv@v7
        with:
          enable-cache: true
          python-version: "3.14"

      - name: Install dependencies
        run: uv sync --dev

      - name: Run ansible-lint
        run: uv run ansible-lint playbooks/

  molecule:
    name: Molecule Test (${{ matrix.platform }})
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        platform:
          - ubuntu-jammy
          - ubuntu-noble
          - debian-bookworm
          - debian-trixie
    steps:
      - name: Check out code
        uses: actions/checkout@v4

      - name: Install uv
        uses: astral-sh/setup-uv@v7
        with:
          enable-cache: true
          python-version: "3.14"

      - name: Install dependencies
        run: uv sync --dev

      - name: Run Molecule test for ${{ matrix.platform }}
        run: uv run molecule test --platform-name ${{ matrix.platform }}
        env:
          PY_COLORS: "1"
          ANSIBLE_FORCE_COLOR: "1"
          ANSIBLE_LOG_PATH: ${{ runner.temp }}/ansible-${{ matrix.platform }}.log
          # ANSIBLE_VERBOSITY: "4"
          # MOLECULE_VERBOSITY: "3"
          # MOLECULE_DEBUG: "1"

      # - name: Upload Ansible log for ${{ matrix.platform }}
      #   if: ${{ always() }}
      #   uses: actions/upload-artifact@v6
      #   with:
      #     name: ansible-log-${{ matrix.platform }}
      #     path: ${{ runner.temp }}/ansible-${{ matrix.platform }}.log
      #     if-no-files-found: ignore
